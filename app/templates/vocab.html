{% extends "base.html" %}
{% block title %}å–®å­—æœ¬ï½œéš¨èº«å–®å­—æœ¬{% endblock %}
{% block content %}
<section class="card">
  <h2>å–®å­—æœ¬</h2>
  <p class="section-lead">
    ç›®å‰å…±æ”¶è— <strong>{{ entries|length }}</strong> å€‹å–®å­—ï¼Œä»Šæ—¥å¾…è¤‡ç¿’ <strong>{{ due_count }}</strong> å€‹ã€‚
  </p>
  {% if entries %}
    <div class="vocab-list">
      {% for entry in entries %}
        <article class="vocab-item">
          <header class="vocab-item__header">
            <div>
              <h3>{{ entry.word }}</h3>
              <p class="vocab-item__meta">
                ä¸‹ä¸€æ¬¡è¤‡ç¿’ï¼š{{ entry.next_review }} Â· é€£å‹ {{ entry.success_streak }} Â· å·²è¤‡ç¿’ {{ entry.review_count }} æ¬¡
              </p>
            </div>
            <button type="button" class="speak-button" data-word="{{ entry.word }}" aria-label="æ’­æ”¾ {{ entry.word }} çš„ç™¼éŸ³">
              ğŸ”Š ç™¼éŸ³
            </button>
          </header>
          <div class="vocab-item__body">
            <div class="definition-block">
              <div class="definition-preview" data-expanded="false">{{ entry.definition }}</div>
              <button type="button" class="definition-toggle" hidden>å±•é–‹æ›´å¤š</button>
            </div>
            {% if entry.context %}
              <p class="vocab-item__context">ä¾‹å¥ï¼š{{ entry.context }}</p>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <p>é‚„æ²’æœ‰ä»»ä½•å–®å­—ï¼Œå¿«åˆ°ã€Œæ–°å¢å–®å­—ã€é é¢é–‹å§‹å»ºç«‹ä½ çš„å–®å­—åº«å§ï¼</p>
  {% endif %}
</section>
{% endblock %}

{% block extra_scripts %}
  <script>
    (function () {
      const speakWord = (text) => {
        if (
          !text ||
          !('speechSynthesis' in window) ||
          typeof window.SpeechSynthesisUtterance !== 'function'
        ) {
          return;
        }
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 0.95;
        window.speechSynthesis.speak(utterance);
      };

      document.querySelectorAll('.speak-button').forEach((button) => {
        button.addEventListener('click', () => {
          const word = button.dataset.word || '';
          speakWord(word.trim());
        });
      });

      const updateToggleState = (preview, toggle) => {
        if (!preview || !toggle) {
          return;
        }
        const needsToggle = preview.scrollHeight - preview.clientHeight > 8;
        toggle.hidden = !needsToggle;
        if (!needsToggle) {
          preview.dataset.expanded = 'true';
        }
      };

      document.querySelectorAll('.definition-block').forEach((block) => {
        const preview = block.querySelector('.definition-preview');
        const toggle = block.querySelector('.definition-toggle');
        if (!preview || !toggle) {
          return;
        }

        const init = () => {
          updateToggleState(preview, toggle);
        };

        if (document.readyState === 'complete') {
          init();
        } else {
          window.addEventListener('load', init, { once: true });
        }

        toggle.addEventListener('click', () => {
          const expanded = preview.dataset.expanded === 'true';
          preview.dataset.expanded = expanded ? 'false' : 'true';
          toggle.textContent = expanded ? 'å±•é–‹æ›´å¤š' : 'æ”¶èµ·å…§å®¹';
        });
      });
    })();
  </script>
{% endblock %}
