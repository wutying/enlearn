{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>快速新增單字</h2>
  <p class="section-lead">
    今日待複習：<strong>{{ due_count }}</strong> 個單字，
    單字本共有 <strong>{{ total_count }}</strong> 筆紀錄。
  </p>
  <form
    method="post"
    action="{{ url_for('add_entry_route') }}"
    class="form-grid"
    id="add-entry-form"
    autocomplete="off"
  >
    <input type="hidden" name="lookup_state" id="lookup-state" value="idle" />
    <label>
      單字 / 片語
      <input
        type="text"
        name="word"
        placeholder="ex: serendipity"
        required
        autocomplete="off"
      />
      <small class="input-hint">輸入後會自動查詢並帶入翻譯。</small>
    </label>
    <label>
      解釋或翻譯
      <textarea
        name="definition"
        rows="3"
        placeholder="ex: 意外得到的驚喜收穫"
        required
        autocomplete="off"
      ></textarea>
      <small id="lookup-status" class="lookup-status" aria-live="polite"></small>
    </label>
    <label>
      情境或例句（選填）
      <textarea
        name="context"
        rows="3"
        placeholder="ex: Finding the café was pure serendipity."
        autocomplete="off"
      ></textarea>
      <small class="input-hint">可直接輸入，或從建議例句中選擇；若未選擇將自動使用第一個例句。</small>
      <div
        id="example-suggestions"
        class="example-suggestions"
        hidden
        aria-live="polite"
      >
        <p class="example-suggestions__title">建議例句</p>
        <ul class="example-suggestions__list"></ul>
      </div>
    </label>
    <div class="form-actions">
      <button type="button" class="btn-primary" id="speak-word-button">發音</button>
      <button type="submit" class="btn-primary">新增單字</button>
    </div>
  </form>
</section>
{% endblock %}

{% block extra_scripts %}
  <script>
    (function () {
      const wordInput = document.querySelector('input[name="word"]');
      const defInput = document.querySelector('textarea[name="definition"]');
      const contextInput = document.querySelector('textarea[name="context"]');
      const statusEl = document.getElementById('lookup-status');
      const lookupStateInput = document.getElementById('lookup-state');
      const form = document.getElementById('add-entry-form');
      const examplesContainer = document.getElementById('example-suggestions');
      const examplesList = examplesContainer
        ? examplesContainer.querySelector('.example-suggestions__list')
        : null;
      const defaultContextPlaceholder = contextInput
        ? contextInput.getAttribute('placeholder') || ''
        : '';
      const WORD_PATTERN = /^[A-Za-z][A-Za-z\s'-]*$/;
      const INVALID_WORD_MESSAGE =
        '請輸入有效的英文單字（僅限英文字母、空格、連字符或撇號）。';
      if (!wordInput || !defInput || !statusEl || !contextInput) {
        return;
      }

      const speakWord = (text) => {
        if (
          !text ||
          !('speechSynthesis' in window) ||
          typeof window.SpeechSynthesisUtterance !== 'function'
        ) {
          return;
        }
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 0.95;
        window.speechSynthesis.speak(utterance);
      };

      const focusWordInput = () => {
        wordInput.focus();
        if (typeof wordInput.select === 'function') {
          wordInput.select();
        }
      };

      focusWordInput();

      let definitionManuallyEdited = false;
      let manualEditWord = '';
      let lookupDelay = null;
      let activeController = null;
      let currentExamples = [];
      let selectedExampleIndex = null;

      const updateExampleSelection = () => {
        if (!examplesList) {
          return;
        }
        const buttons = examplesList.querySelectorAll('.example-option');
        buttons.forEach((button, index) => {
          const isSelected = index === selectedExampleIndex;
          button.classList.toggle('is-selected', isSelected);
          button.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
        });
      };

      const renderExamples = () => {
        if (!examplesContainer || !examplesList) {
          return;
        }
        examplesList.innerHTML = '';
        if (!currentExamples.length) {
          examplesContainer.hidden = true;
          contextInput.placeholder = defaultContextPlaceholder;
          return;
        }

        currentExamples.forEach((example, index) => {
          const item = document.createElement('li');
          item.className = 'example-suggestions__item';
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'example-option';
          if (index === 0) {
            button.classList.add('example-option--primary');
          }
          button.textContent = example;
          button.title = example;
          button.addEventListener('click', () => {
            contextInput.value = example;
            selectedExampleIndex = index;
            updateExampleSelection();
            contextInput.focus();
          });
          item.appendChild(button);
          examplesList.appendChild(item);
        });

        examplesContainer.hidden = false;
        contextInput.placeholder = currentExamples[0] || defaultContextPlaceholder;
        updateExampleSelection();
      };

      const setExamples = (examples, wordForExamples = '') => {
        const sanitized = Array.isArray(examples)
          ? examples
              .filter((item) => typeof item === 'string')
              .map((item) => item.trim())
              .filter((item, index, arr) => item && arr.indexOf(item) === index)
          : [];
        currentExamples = sanitized;
        selectedExampleIndex = null;
        contextInput.dataset.examplesForWord = wordForExamples;
        renderExamples();
      };

      setExamples([]);

      contextInput.addEventListener('input', () => {
        selectedExampleIndex = null;
        contextInput.dataset.examplesForWord = '';
        updateExampleSelection();
      });

      const setStatus = (message, state) => {
        statusEl.textContent = message;
        statusEl.dataset.state = state;
        if (lookupStateInput) {
          lookupStateInput.value = state;
        }
      };

      const cancelLookup = () => {
        if (lookupDelay) {
          clearTimeout(lookupDelay);
          lookupDelay = null;
        }
        if (activeController) {
          activeController.abort();
          activeController = null;
        }
      };

      const scheduleLookup = (word) => {
        cancelLookup();
        setStatus('查詢翻譯中…', 'loading');
        lookupDelay = setTimeout(() => performLookup(word), 350);
      };

      const performLookup = async (word) => {
        const controller = new AbortController();
        activeController = controller;

        try {
          const response = await fetch(`/lookup?word=${encodeURIComponent(word)}`, {
            signal: controller.signal,
          });

          if (!response.ok) {
            throw new Error('lookup_failed');
          }

          const data = await response.json();

          if (wordInput.value.trim() !== word) {
            return;
          }

          if (data.status === 'invalid') {
            setStatus(INVALID_WORD_MESSAGE, 'invalid');
            setExamples([]);
            return;
          }

          if (data.status === 'ok' && data.translation) {
            const shouldAutofill =
              !definitionManuallyEdited ||
              !defInput.value.trim() ||
              defInput.dataset.autofillWord === word;

            if (shouldAutofill) {
              defInput.value = data.translation;
              defInput.dataset.autofillWord = word;
              definitionManuallyEdited = false;
              manualEditWord = '';
            }
            if (Array.isArray(data.meanings) && data.meanings.length > 1) {
              setStatus(
                `已帶入多個翻譯：${data.meanings.join('、')}。`,
                'success'
              );
            } else {
              setStatus('已自動帶入翻譯，可視需要調整。', 'success');
            }
            setExamples(Array.isArray(data.examples) ? data.examples : [], word);
          } else if (data.status === 'not_found') {
            setStatus('找不到翻譯，請自行輸入。', 'warning');
            setExamples(Array.isArray(data.examples) ? data.examples : [], word);
          } else {
            setStatus('請輸入單字以查詢翻譯。', 'idle');
            setExamples([], word);
          }
        } catch (err) {
          if (err.name === 'AbortError') {
            return;
          }
          setStatus('查詢翻譯失敗，請稍後再試或自行輸入。', 'error');
          setExamples([]);
        } finally {
          if (activeController === controller) {
            activeController = null;
          }
        }
      };

      defInput.addEventListener('input', () => {
        definitionManuallyEdited = true;
        defInput.dataset.autofillWord = '';
        manualEditWord = wordInput.value.trim();
      });

      wordInput.addEventListener('input', () => {
        const word = wordInput.value.trim();
        const examplesForWord = contextInput.dataset.examplesForWord || '';

        if (examplesForWord && examplesForWord !== word) {
          const currentValue = contextInput.value.trim();
          if (!currentValue || currentExamples.includes(currentValue)) {
            contextInput.value = '';
          }
          setExamples([], '');
        }

        if (defInput.dataset.autofillWord && defInput.dataset.autofillWord !== word) {
          defInput.value = '';
          defInput.dataset.autofillWord = '';
          definitionManuallyEdited = false;
          manualEditWord = '';
        } else if (
          definitionManuallyEdited &&
          manualEditWord &&
          manualEditWord !== word &&
          !manualEditWord.startsWith(word) &&
          !word.startsWith(manualEditWord)
        ) {
          definitionManuallyEdited = false;
          manualEditWord = '';
          defInput.value = '';
        }

        if (!word) {
          cancelLookup();
          if (!definitionManuallyEdited) {
            defInput.value = '';
          }
          manualEditWord = '';
          setExamples([], '');
          setStatus('請輸入單字以查詢翻譯。', 'idle');
          return;
        }

        if (!WORD_PATTERN.test(word)) {
          cancelLookup();
          if (!definitionManuallyEdited) {
            defInput.value = '';
          }
          manualEditWord = '';
          setExamples([], '');
          setStatus(INVALID_WORD_MESSAGE, 'invalid');
          return;
        }

        scheduleLookup(word);
      });

      setStatus('輸入單字後會自動查詢翻譯。', 'idle');
      defInput.dataset.autofillWord = '';

      const speakButton = document.getElementById('speak-word-button');

      if (speakButton) {
        speakButton.addEventListener('click', () => {
          const value = wordInput.value.trim();
          if (value) {
            speakWord(value);
          }
        });
      }

      if (form) {
        form.addEventListener('submit', (event) => {
          const value = wordInput.value.trim();
          const state = lookupStateInput ? lookupStateInput.value : statusEl.dataset.state;
          if (!WORD_PATTERN.test(value)) {
            event.preventDefault();
            setStatus(INVALID_WORD_MESSAGE, 'invalid');
            focusWordInput();
            return;
          }

          if (state === 'invalid') {
            event.preventDefault();
            setStatus(INVALID_WORD_MESSAGE, 'invalid');
            focusWordInput();
            return;
          }

          if (state === 'warning' || state === 'error') {
            event.preventDefault();
            setStatus('查無此單字，請檢查拼字後再試。', 'warning');
            focusWordInput();
            return;
          }
          if (state === 'loading') {
            event.preventDefault();
            setStatus('請等待翻譯查詢完成後再新增。', 'warning');
            return;
          }
          if (!contextInput.value.trim() && currentExamples.length) {
            contextInput.value = currentExamples[0];
            selectedExampleIndex = 0;
            contextInput.dataset.examplesForWord = value;
            updateExampleSelection();
          }
          if (value) {
            speakWord(value);
          }
        });
      }
    })();
  </script>
{% endblock %}
