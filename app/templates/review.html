{% extends "base.html" %}
{% block title %}è¤‡ç¿’å–®å­—ï½œéš¨èº«å–®å­—æœ¬{% endblock %}
{% block content %}
<section class="card review-card">
  <h2>è¤‡ç¿’æ¨¡å¼</h2>
  <p class="storage-hint">æ‰€æœ‰å–®å­—éƒ½ä¿å­˜åœ¨ <code>{{ storage_path }}</code>ã€‚</p>
  <p class="review-mode-label">
    ç›®å‰æ¨¡å¼ï¼š
    {% if mode == 'word-first' %}
      é¡¯ç¤ºå–®å­—çŒœè§£é‡‹
    {% else %}
      é¡¯ç¤ºè§£é‡‹è¼¸å…¥å–®å­—
    {% endif %}
  </p>
  {% if entry %}
    <p>é‚„æœ‰ <strong>{{ remaining }}</strong> å€‹å–®å­—å¾…è¤‡ç¿’ã€‚</p>
    {% if mode == 'word-first' %}
      <div class="review-word">
        <div class="review-word__header">
          <button
            type="button"
            class="speak-button"
            data-speak-word="{{ entry.word }}"
            aria-label="æ’­æ”¾ {{ entry.word }} çš„ç™¼éŸ³"
          >
            ğŸ”ˆ
          </button>
          <h3>{{ entry.word }}</h3>
        </div>
        {% if entry.context %}
          <p class="context">{{ entry.context }}</p>
        {% endif %}
      </div>
      <details class="definition">
        <summary>é¡¯ç¤ºè§£é‡‹</summary>
        <p>{{ entry.definition }}</p>
      </details>
      <p class="review-meta">å·²è¤‡ç¿’ {{ entry.review_count }} æ¬¡ï¼Œé€£å‹ {{ entry.success_streak }}ã€‚</p>
      <form method="post" action="{{ url_for('review_result', entry_id=entry.id) }}" class="review-actions">
        <input type="hidden" name="mode" value="word-first" />
        <button name="result" value="remembered" class="btn-primary">æˆ‘è¨˜å¾—</button>
        <button name="result" value="forgot" class="btn-secondary">éœ€è¦åŠ å¼·</button>
      </form>
    {% else %}
      <div class="review-definition">
        <h3>è§£é‡‹ / ç¿»è­¯</h3>
        <p>{{ entry.definition }}</p>
        {% if entry.context %}
          <p class="context">{{ entry.context }}</p>
        {% endif %}
      </div>
      <p class="review-meta">å·²è¤‡ç¿’ {{ entry.review_count }} æ¬¡ï¼Œè«‹è¼¸å…¥å°æ‡‰çš„å–®å­—æˆ–ç‰‡èªã€‚</p>
      <form method="post" action="{{ url_for('review_result', entry_id=entry.id) }}" class="definition-first-form">
        <input type="hidden" name="mode" value="definition-first" />
        <label>
          æˆ‘çš„ç­”æ¡ˆ
          <input type="text" name="answer" placeholder="è¼¸å…¥å–®å­—" required />
        </label>
        <button type="submit" class="btn-primary">é€å‡ºç­”æ¡ˆ</button>
      </form>
    {% endif %}
    <form method="post" action="{{ url_for('review_skip', entry_id=entry.id) }}" class="review-actions">
      <input type="hidden" name="mode" value="{{ mode }}" />
      <button type="submit" class="btn-link">å…ˆè·³é</button>
    </form>
  {% else %}
    <p>ç›®å‰æ²’æœ‰éœ€è¦è¤‡ç¿’çš„å–®å­—ï¼Œå¤ªæ£’äº†ï¼</p>
    <a class="btn-primary" href="{{ url_for('index') }}">å›å»æ–°å¢æ›´å¤šå–®å­—</a>
  {% endif %}
</section>
{% endblock %}

{% block extra_scripts %}
  <script>
    (function () {
      const speakButtons = document.querySelectorAll('[data-speak-word]');
      if (!speakButtons.length) {
        return;
      }

      const supportsSpeech =
        'speechSynthesis' in window && typeof window.SpeechSynthesisUtterance !== 'undefined';
      if (!supportsSpeech) {
        speakButtons.forEach((btn) => {
          btn.disabled = true;
          btn.classList.add('speak-button--disabled');
          btn.title = 'ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³æ’­æ”¾';
        });
        return;
      }

      const speakWord = (text) => {
        if (!text) {
          return;
        }
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 0.95;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
      };

      speakButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const word = btn.getAttribute('data-speak-word');
          speakWord(word);
        });
      });
    })();
  </script>
{% endblock %}
